# 5.1 트랜잭션 

> 트랜잭션은 `작업의 완전성을 보장`해 주는 것으로 논리적인 작업 셋을 모두 완벽하게 처리하거나 처리하지 못할 경우, 원상태로 복구해서 작업의 일부만 적용되는 현상이 발생하지 않게 만들어주는 기능

- `잠금(Lock)` 은 동시성을 제어하기 위한 기능이고, `트랜잭션`은 데이터의 정합성을 보장하기 위한 기능
    - 하나의 회원 정보 레코드를 여러 connection에서 동시에 변경하려고 하는데 잠금이 없다면, `하나의 데이터를 여러 connection에서 동시에 변경할 수 있게 됨`
    - 결과적으로 해당 레코드의 값은 예측할 수 없는 상태가 됨

## 5.1.1 MySQL에서의 트랜잭션

- 트랜잭션은 하나의 논리적인 작업 셋에 하나의 쿼리가 있든 두 개 이상의 쿼리가 있든 관계없이 논리적인 작업 셋 자체가 100% 적용되거나(COMMIT을 실행했을 때) 아무것도 적용되지 않아야(ROLLBACK 또는 트랜잭션을 ROLLBACK시키는 오류가 발생했을 때) 함을 보장해 주는 것을 의미

> 트랜잭션 관점에서의 InnoDB 테이블과 MyISAM 테이블 차이

````sql
-- 1. 테이블 생성 및 데이터 1건 INSERT
-- MyISAM
CREATE TABLE tab_myisam (fdpk INT NOT NULL, PRIMARY KEY (fdpk) ) ENGINE=MyISAM；
INSERT INTO tab_myisam (fdpk) VALUES (3);

-- INNODB
CREATE TABLE tab_innodb ( fdpk INT NOT NULL, PRIMARY KEY (fdpk) ) ENGINE=INNODB；
INSERT INTO tab_innodb (fdpk) VALUES (3)；

-- 2. AUTO-COMMIT 활성화
SET autocommit=ON；
INSERT INTO tab_myisam (fdpk) VALUES (1),(2),(3)；
INSERT INTO tab_innodb (fdpk) VALUES (1),(2),(3)；

-- 3. INSERT 추가 (Primary 키 중복 오류로 인한 INSERT 실패)
INSERT INTO tab_myisam (fdpk) VALUES (1),(2),(3)；
ERROR 1062 (23000)： Duplicate entry '3' for key 'PRIMARY'

INSERT INTO tab.innodb (fdpk) VALUES (1),(2),(3)；
ERROR 1062 (23000)： Duplicate entry '3' for key 'PRIMARY'

-- 4. 결과
SELECT * FROM tab_myisam；
| fdpk |
--------
|    1 |
|    2 |
|    3 |

SELECT * FROM tab_innodb
| fdpk |
--------
|    3 |
````

- MylSAM 은 테이블에서 실행되는 쿼리는 이미 INSERT 된 `‘1’과 ‘2’를 그대로 두고 쿼리 실행 종료`
  - 트랜잭션을 미지원
- InnoDB는 쿼리 중 일부라도 오류가 발생하면 전체를 원 상태로 만든다는 트랜잭션의 원칙대로 `INSERT 문장을 실행하기 전 상태로 그대로 복구`
  - - 트랜잭션을 지원

## 5.1.2 주의사항 

- 트랜잭션 또한 DBMS의 커넥션과 동일하게 꼭 필요한 최소의 코드에만 적용하여 `트랜잭션 범위를 최소화` 하는 것이 좋다

> 게시물 작성 트랜잭션 예시  

1) 처리 시작
   - => 데이터베이스 커넥션 생성
   - => 트랜잭션 시작
2) 사용자의 로그인 여부 확인
3) 사용자의 글쓰기 내용의 오류 여부 확인
4) 업로드된 첨부 파일 확인 및 저장
5) 사용자의 입력 내용을 DBMS에 저장
6) 첨부 파일 정보를 DBMS에 저장
7) 저장된 내용 또는 기타 정보를 DBMS에서 조회
8) 게시물 등록에 대한 알림 메일 발송
9) 알림 메일 발송 이력을 DBMS에 저장
   - <= 트랜잭션 종료(COMMIT)
   - <= 데이터베이스 커넥션 반납
10) 처리 완료

- 개선 전 트랜잭션에 대한 영향도
  1. 실제 DBMS 에 데이터를 저장하는 작업은 5번부터 시작되기 때문에 `2번, 3번, 4번은 트랜잭션에 포함될 필요가 없음`
     - db connection 개수는 제한적이기 때문에 소유 시간이 길어질수록 여유 db connection 개수는 줄어듬
  2. 8번에서와 같이 `메일 전송`, `FTP 파일 전송`, `네트워크를 통해 원격 서버와 통신`하는 등과 같은 작업은 DBMS의 트랜잭션 내에서 제거하는 것이 좋음
     - 프로그램 실행 중 메일 서버와 통신할 수 없는 상황이 발생하게 되면 웹 서버뿐 아니라 DB 서버까지 영향
  3. 5,6 번은 같은 트랙잭션으로 묶고, 7번은 단순 조회성이니 트랜잭션을 사용하지 않아도 되고 9번은 성격이 다르니 다른 트랜잭션으로 분리하는 것이 좋음

> 게시물 작성 트랜잭션 예시 개선

1) 처리 시작
2) 사용자의 로그인 여부 확인
3) 사용자의 글쓰기 내용의 오류 발생 여부 확인
4) 첨부로 업로드된 파일 확인 및 저장
   - => 데이터베이스 커넥션 생성(또는 커넥션 풀에서 가져오기)
   - => 트랜잭션 시작
5) 사용자의 입력 내용을 DBMS에 저장
6) 첨부 파일 정보를 DBMS에 저장
   - <= 트랜잭션 종료(COMMIT)
7) 저장된 내용 또는 기타 정보를 DBMS에서 조회
8) 게시물 등록에 대한 알림 메일 발송
   - => 트랜잭션 시작
9) 알림 메일 발송 이력을 DBMS에 저장
   - <= 트랜잭션 종료(COMMIT)
   - <= 데이터베이스 커넥션 종료(또는 커넥션 풀에 반납)
10) 처리 완료

> 정리
- 프로그램의 코드가 데이터베이스 커넥션을 가지고 있는 범위와 트랜잭션이 활성화돼 있는 프로그램의 범위를 최소화 하자
- 네트워크 작업이 있는 경우에는 반드시 트랜잭션에서 배제 하자