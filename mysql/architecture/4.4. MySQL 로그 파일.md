# 4.4. MySQL 로그 파일

## 4.4.1 에러 로그 파일

- 에러 로그 파일의 위치는 `MySQL 설정 파일(my.cnf)`에서 `log_error` 라는 이름의 파라미터로 정의된 경로에 생성
- MySQL 설정 파일에 별도로 정의되지 않은 경우, `datadir` 파라미터에 `.err` 라는 확장자가 붙은 파일로 생성

### 4.4.1.1 MySQL이 시작하는 과정과 관련된 정보성 및 에러 메시지

- MySQL 서버가 정상적으로 기동
  - ‘mysqld： ready for connections’ 메시지 확인), 새로 변경하거나 추가한 파라미터에 대한 특별한 에러나 경고성 메시지가 없다면 정상적으로 적용된 것으로 판단하면 됨
- 특정 변수가 무시된 경우
  - MySQL 서버는 정상적으로 기동하지만 해당 파라미터는 MySQL에 적용되지 못함
- 변수명이나 값을 인식하지 못하는 경우
  - 에러 메시지 출력하고, 시작하지 못했다는 메시지 출력

### 4.4.1.2 마지막으로 종료할 때 비정상적으로 종료된 경우 나타나는 InnoDB의 트랜잭션 복구 메시지

> InnoDB의 경우, MySQL 서버가 비정상적으로 종료됐다면 다시 시작되면서 `redo log` 를 읽어 완료하지 못한 트랜잭션을 다시 처리하는 작업 진행

- `innodb_force_recovery` : InnoDB 스토리지 엔진이 심각한 손상이나 크래시가 발생했을 때 데이터 복구를 시도하기 위해 사용하는 옵션

### 4.4.1.3 쿼리 처리 도중에 발생하는 문제에 대한 에러 메시지

- 쿼리 도중 발생하는 문제점은 사전 예방이 어려우며, 주기적으로 에러 로그 파일을 검토하는 과정에서 인지 가능
- 쿼리의 실행 도중 발생한 에러나 복제에서 문제가 될 만한 쿼리에 대한 경고 메시지가 에러 로그에 기록

### 4.4.1.4 비정상적으로 종료된 커넥션 메시지 (Aborted connection)

> `클라이언트 애플리케이션에서 정상적으로 접속 종료를 하지 못하고 프로그램이 종료된 경우` MySQL 서버의 에러 로그 파일에 이런 내용이 기록

- `max_connect_errors` : 클라이언트의 반복된 연결 실패 횟수에 따라 해당 IP 주소를 일시적으로 차단하는 보안 매커니즘

- 주요 원인 
  - 클라이언트 프로그램이 종료 전에 mysql_close()를 호출하지 않은 경우
  - 데이터 전송 중, 클라이언트 프로그램이 갑자기 종료된 경우
  - 클라이언트가 wait_timeout 과 같이 설정된 시간 이상으로 동작이 없는 경우
  - 클라이언트가 데이터베이스에 접근할 권한이 없는 경우
  - connection packet 이 올바른 정보를 가지고 있지 않은 경우
  - max_allowed_packet 변수 값이 너무 작게 설정되어 있거나 쿼리가 mysqld에 할당한 메모리보다 많은 양을 요구할 경우 (Packet Too Large)

### 4.4.1.5 InnoDB의 모니터링 또는 상태 조회 명령의 결과 메시지 (SHOW ENGINE INNODB STATUS)

- InnoDB의 `테이블 모니터링`, `락 모니터링`, `InnoDB의 엔진 상태를 조회`하는 명령은 상대적으로 큰 메시지를 에러 로그 파일에 기록
- `모니터링을 사용한 이후`에는 다시 `비활성화`해서 에러 로그 파일이 커지지 않게 만들어야 한다

### 4.4.1.6 MySQL 의 종료 메시지

>  MySQL 이 종료되거나 재시작 되는 경우, 사유를 찾기 위해서는 에러 로그 파일에서 MySQL이 마지막으로 종료되면서 출력한 메시지를 확인하는 것이 유일한 방법

1. MYSQL 서버를 누군가가 종료시킨 경우 
   - 에러 로그 파일에서 `Received SHUTDOWN from user` 메시지 확인 가능

2. 종료 관련 메시지가 없거나 스택 트레이스와 같이 출력되는 경우
   - 스택트레이스를 참조해서 MYSQL의 버전을 업그레이드 하거나 회피책을 찾는것이 최선의 방법
    
## 4.4.2 제너럴 쿼리 로그 파일

> MySQL 서버에서 실행되는 쿼리로 어떤 것들이 있는지 전체 목록을 뽑아서 검토할 때는 `쿼리 로그`를 활성화해서 쿼리를 쿼리 로그 파일로 기록

- `제너럴 쿼리 로그`는 실행되기 전에 `MySQL이 쿼리 요청을 받으면 바로 기록`하기 때문에 `쿼리 실행 중에 에러가 발생해도 일단 로그 파일에 기록`
- `general_log_file`
  - 쿼리 로그 파일의 경로
- `log.output`
  - 쿼리 로그를 파일로 저장할지 테이블로 저장할지 설정

## 4.4.3 슬로우 쿼리 로그

> MySQL 서버의 쿼리 튜닝은 크게 `서비스가 적용되기 전에 전체적으로 튜닝`하는 경우와 `서비스 운영 중에 MySQL 서버의 전체적인 성능 저하를 검사`하거나 `정기적인 점검을 위한 튜닝`으로 나눌 수 있음

- 슬로우 쿼리 로그 파일에는 `long_query_time` 시스템 변수에 설정한 시간 이상의 시간이 소요된 쿼리가 모두 기록
- 슬로우 쿼리 로그 파일에 기록되는 쿼리는 일단 정상적으로 실행이 완료됐고 `실행하는 데 걸린 시간이 long_query_time 에 정의된 시간보다 많이 걸린 쿼리`

````sql
# Time： 2020-07-19T15：44：22.178484+09:00
# User@Host： root[root] @ localhost [127.0.0.1] Id；
# Query_time： 1.180245 Lock_time： 0.002658 Rows_sent： 1 Rows_examined： 2844047
use employees；
SET timestamp=1595141060；
select enip_no, max(salary) from salaries；
````
- `Time`
  - 쿼리가 시작된 시간이 아니라 쿼리가 종료된 시점을 의미 (쿼리가 언제 시작됐는지 확인하려면 ’Time' 항목에 나온 시간에서 'Query—time' 만큼 빼야 함)
- `User@Host`
  - 쿼리를 실행한 사용자의 계정
- `Query_time`
  - 쿼리가 실행되는 데 걸린 전체 시간을 의미
- `Lock_time`
  - 테이블 잠금에 대한 대기 시간
  - 값이 0이 아니라고 해서 무조건 잠금 대기가 있었다고 판단하기 어려운데, 잠금 체크와 같은 코드 실행 부분의 시간까지 모두 포함되기 때문
  - 이 값이 매우 작은 값이면 무시해도 무방
- `Rows_examined`
  - 쿼리가 처리되기 위해 몇 건의 레코드에 접근했는지를 의미
- `Rows_sent`
  - 실제 몇 건의 처리 결과를 클라이언트로 보냈는지 의미로, `Rows_examined 의 레코드 건수는 높지만 Rows_sent 가 상당히 적다면, 이 쿼리는 조금 더 적은 레코드만 접근하도록 튜닝해 볼 가치가 있음`