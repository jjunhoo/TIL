## 프로듀서의 내부 동작 원리와 구현

### 5.1 파티셔너 

- 카프카의 토픽은 병렬 처리가 가능하도록 하기 위해 파티션으로 나뉘고, 최소 하나 또는 둘 이상의 파티션으로 구성
- 프로듀서가 보낸 메시지는 해당 토픽 내 각 파티션의 '로그 세그먼트'에 저장
- 따라서, 프로듀서는 카프카로 메시지를 보낼 때 해당 토픽의 어느 파티션으로 메시지를 보내야 할지 결정이 필요하며, 이때 사용하는 것이 '파티셔너'
- 프로듀서가 파티션을 결정하는 알고리즘은 기본적으로 '메시지의 키를 해시(Hash)' 처리하여 파티션을 구하는 방식 사용
  - 메시지의 키값이 동일한 경우, 모두 같은 파티션으로 전송

- 많은 양의 메시지가 카프카로 인입되는 경우, 카프카는 클라이언트의 처리량을 높이기 위해 '토픽의 파티션을 늘릴 수 있는 기능 제공'
  - 파티션 수가 변경됨과 동시에 '메시지의 키와 매핑된 해시 테이블 변경'
  - 파티션 수가 변경된 이후에는 '동일한 메시지 키를 이용하여 메시지를 전송하더라도 다른 파티션으로 전송될 수 있음'

> 파티션 수 증가에 따른 해시 변경 방식

![캡처](https://velog.velcdn.com/images/woorung/post/caa38de4-35a1-4c78-9e4a-8b43e7770ba0/image.png)

- 메시지의 키를 이용해 카프카로 메시지를 전송하는 경우, 관리자의 의도와는 다른 방식으로 메시지 전송이 이뤄질 수 있으므로 되도록 파티션 수 변경을 하지 않는 것을 권장
