## 프로듀서의 내부 동작 원리와 구현

### 5.1 파티셔너 

- 카프카의 토픽은 병렬 처리가 가능하도록 하기 위해 파티션으로 나뉘고, 최소 하나 또는 둘 이상의 파티션으로 구성
- 프로듀서가 보낸 메시지는 해당 토픽 내 각 파티션의 '로그 세그먼트'에 저장
- 따라서, 프로듀서는 카프카로 메시지를 보낼 때 해당 토픽의 어느 파티션으로 메시지를 보내야 할지 결정이 필요하며, 이때 사용하는 것이 '파티셔너'
- 프로듀서가 파티션을 결정하는 알고리즘은 기본적으로 '메시지의 키를 해시(Hash)' 처리하여 파티션을 구하는 방식 사용
  - 메시지의 키값이 동일한 경우, 모두 같은 파티션으로 전송

- 많은 양의 메시지가 카프카로 인입되는 경우, 카프카는 클라이언트의 처리량을 높이기 위해 '토픽의 파티션을 늘릴 수 있는 기능 제공'
  - 파티션 수가 변경됨과 동시에 '메시지의 키와 매핑된 해시 테이블 변경'
  - 파티션 수가 변경된 이후에는 '동일한 메시지 키를 이용하여 메시지를 전송하더라도 다른 파티션으로 전송될 수 있음'

> 파티션 수 증가에 따른 해시 변경

![캡처](https://velog.velcdn.com/images/woorung/post/caa38de4-35a1-4c78-9e4a-8b43e7770ba0/image.png)

- 메시지의 키를 이용해 카프카로 메시지를 전송하는 경우, 관리자의 의도와는 다른 방식으로 메시지 전송이 이뤄질 수 있으므로 되도록 파티션 수 변경을 하지 않는 것을 권장

#### 5.1.1 라운드 로빈 전략

- 프로듀서의 메시지 중 레코드(메시지)의 key 값은 필수값이 아님
  - 따라서, 레코드 key 값을 지정하지 않고 메시지 전송 가능
  - key 값 미지정 
    - key 값 : null
    - 기본 (Default) 알고리즘 : 라운드 로빈

- 파티셔너를 거친 후 레코드들은 배치 처리를 위해 프로듀서의 '버퍼 메모리 영역에서 잠시 대기 후 카프카로 전송'
  - 배치 처리를 위해 잠시 메시지들이 대기하는 과정에서 라운드 로빈 전략은 비효율

> 비효율적인 라운드 로빈 전략 예시

![캡처](https://velog.velcdn.com/images/woorung/post/79d7f6a7-05e6-4174-923c-5881e3ecf13d/image.png)

- 토픽 : 1 (A) 
- 파티션 수 : 3
- 각 파티션별로 배치 전송을 위해 필요한 레코드 수 : 3 
   

- 토픽 A - 파티션 2 는 배치와 압축의 효과를 얻지 못한 채 레코드 하나만 카프카로 전송되므로 비효율
  - 프로듀서 옵션 설정을 통해 '특정 시간 초과 시 즉시 카프카로 레코드들을 전송'하도록 설정 가능
   

- 카프카에서는 이러한 비효율적 전송 방식을 보완하기 위해 '스티키 파티셔닝 (Sticky Partitioning) 전략 도입

#### 5.1.2 스티키 파티셔닝 전략

- \* 하나의 파티션에 레코드 수를 먼저 채워서 카프카로 빠르게 배치 전송하는 전략
- 라운드 로빈 전략에서 지연 시간이 불필요하게 증가되는 비효율적인 전송 방식을 개선하고자 카프카 2.4 버전부터 도입
  
![캡처](https://velog.velcdn.com/images/woorung/post/71a5ddb7-bf9d-4c9d-8378-0051f14e3b3b/image.png)

- 토픽 : 1 (A)
- 파티션 수 : 3
- 각 파티션별로 배치 전송을 위해 필요한 레코드 수 : 3 
   

- 배치를 위한 레코드 수에 도달할 때까지 파티셔너는 다른 파티션으로 보내지 않고, 동일한 파티션으로 레코드 저장
  - '토픽A - 파티션0' 에는 레코드 1~3 까지 채워졌기 때문에 배치를 위한 최소 레코드 수를 충족했으므로 즉시 카프카로 배치 전송 수행 가능

- 라운드 로빈 전략에서는 레코드 5개를 처리했음에도 카프카로 전송하지 못했지만, 스티키 파티셔닝 전략에서는 배치 전송 가능
  - \* 라운드 로빈 전략 보다 효율적
  - \* 메시지 순서가 중요하지 않은 경우 스티키 파티셔닝 전략 적용 권장
  - 스티키 파티셔닝 전략 적용을 통해 약 30% 이상 지연 시간 감소 및 프로듀서의 CPU 사용률 절감 효과
