## 컨슈머의 내부 동작 원리와 구현

### 6.1 컨슈머 오프셋 관리

- 컨슈머의 동작 중 가장 핵심은 '오프셋 관리'
- 컨슈머는 카프카에 저장된 메시지를 꺼내오는 역할을 하기 때문에 컨슈머가 메시지를 어디까지 가져왔는지를 표시하는 것은 매우 중요
- 컨슈머 그룹은 자신의 오프셋 정보를 토픽에 저장
  - consumer offsets 토픽에 각 컨슈머 그룹별로 오프셋 위치 정보 저장

> 컨슈머 기본 동작

![캡처](https://postfiles.pstatic.net/MjAyMjEwMTNfMjU0/MDAxNjY1NjY5ODg0NzQ3.9RB01YI4IXRcGdq-Si1fGZ7cKQmB6HEobwvMVq5qTNkg.bgIl7qItQnTp1dmmFauGqnfTmQ6I2-poi-Kgc6LIjUsg.JPEG.wnsghi1/IMG_1305.jpg?type=w773)

- 컨슈머 그룹 내 컨슈머들은 지정된 토픽의 메시지를 읽은 뒤 읽어온 위치의 오프셋 정보를 'consumer offsets' 에 저장
  - 컨슈머 그룹, 토픽, 파티션 등 내용을 통합하여 저장
- **\* 이를 통해 컨슈머 그룹은 자신의 그룹이 속해 있는 컨슈머의 변경(장애, 이탈 등)이 발생하는 경우, 해당 컨슈머가 어느 위치까지 읽었는지 추적 가능**

> 'consumer offsets' 토픽의 파티션 수 및 리플리케이션 팩터 수

- offsets.topic.num.partitions : 기본값 50 
- offsets.topic.replication.factor : 기본값 3
  - server.properties 파일을 통해 기본값 변경 가능 

### 6.2 그룹 코디네이터

- 컨슈머들은 하나의 컨슈머 그룹의 구성원으로 속함 
- 컨슈머 그룹 내 각 컨슈머들은 서로 자신의 정보 공유 
- 컨슈머 그룹에서 각 컨슈머들에게 작업을 균등하게 분배하는 동작 
  - 컨슈머 리밸런싱 (Consumer Rebalancing)
- 컨슈머 그룹 관리를 위한 별도 코디네이터 
  - 그룹 코디네이터 (Group Coordinator)
  - 목적 : 컨슈머 그룹이 구독한 토픽의 파티션들과 그룹의 멤버들 트래킹 
  - **\* 그룹 코디네이터는 각 컨슈머 그룹별로 존재** 
  - **\* 카프카 클러스터 내 브로커 중 하나에 위치**

> 그룹 코디네이터와 컨슈머 그룹 관계  
 
![캡처](https://postfiles.pstatic.net/MjAyMjEwMTNfMjM3/MDAxNjY1NjcwNzIyMjkz.vTE6yLw4vHJxDTmO7v4JhLLDCZoyYWl88dK2U9HQkYwg.FOl8I4cqWUc9KeNOI71xStuHNp5aCjqTW2vw5ReqxY8g.JPEG.wnsghi1/IMG_1306.jpg?type=w773)

- 컨슈머 그룹이 브로커에 최초 연결 요청 시 브로커 중 하나에 그룹 코디네이터 생성
  - 해당 그룹 코디네이터는 컨슈머 변경, 토픽 파티션 변경 등 감지 및 컨슈머들에게 전파 

> 컨슈머 그룹 등록 과정 

![캡처](https://postfiles.pstatic.net/MjAyMjEwMTNfMTgg/MDAxNjY1NjcwOTYwOTYz.NNXFTHLXK_qLJvppQA9spa6h_cXqf3xI7tLOjw2GNwcg.2m9brGgOZM6YSmUiL5wO_fg-j87wFVA1Jdh6jsrJZMQg.JPEG.wnsghi1/IMG_1307.jpg?type=w773)

1. 컨슈머는 컨슈머 설정값 내 bootstrap.brokers 리스트에 있는 브로커에게 컨슈머 클라이언트와 초기 커넥션을 위한 요청 
2. 해당 요청을 받은 브로커는 그룹 코디네이터 생성 (컨슈머 그룹의 첫 번째 컨슈머가 등록될 때까지 아무 작업도 일어나지 않음)
3. 그룹 코디네이터는 group.initial.rebalance.delay.ms 설정 시간 동안 컨슈머 요청 대기 
4. 컨슈머는 그룹 코디네이터에게 컨슈머 등록 요청 (* 가장 먼저 요청을 보내는 컨슈머가 컨슈머 그룹 리더 지정)
5. 그룹 코디네이터는 해당 컨슈머 그룹이 구독하는 토픽 파티션 리스트 등의 정보를 리더 컨슈머의 요청에 응답
6. 리더 컨슈머는 정해진 컨슈머 파티션 할당 전략에 따라 그룹 내 컨슈머들에게 파티션을 할당하고 그룹 코디네이터에게 전달
7. 그룹 코디네이터는 해당 정보 캐시 및 각 그룹 내 컨슈머들에게 성공 응답
8. 각 컨슈머들은 각자 지정된 토픽 파티션으로부터 메시지를 읽음

> 컨슈머 HeartBeat 옵션 

| 컨슈머 옵션                | 값      | 설명                                                                                                                         |  
|-----------------------|--------|----------------------------------------------------------------------------------------------------------------------------| 
| heartbeat.interval.ms | 3000   | 기본값 : 3000, 그룹 코디네이터와 하트비트 인터벌 시간 (해당 시간은 session.timeout.ms 보다 낮게 설정해야 하며 1/3 수준이 적절)                                     | 
| session.timeout.ms    | 10000  | 기본값 : 10000, 어떤 컨슈머가 특정 시간 안에 하트비트를 받지 못하면 문제가 발생했다고 판단해 컨슈머 그룹에서 해당 컨슈머는 제거되고, 리밸런싱 동작 발생                                 | 
| max.poll.interval.ms  | 300000 | 기본값 : 300000, 컨슈머는 주기적으로 poll() 을 호출하여 토픽으로부터 레코드를 가져오며, poll() 호출 후 최대 5분간 poll() 호출이 없다면 컨슈머에 문제가 있는 것으로 판단하여 리밸런싱 동작 발생 |

### 6.3 스태틱 멤버십

> 컨슈머의 재시작으로 인해 리밸런싱이 일어나는 배경

1. 일반적인 컨슈머 그룹 동작에서는 각 컨슈머를 식별하기 위해 엔티티 ID 부여
  - 생성된 엔티티 ID는 컨슈머 그룹 내에서 임시로 사용되는 값
2. 따라서 컨슈머의 설정 변경 또는 컨슈머 재시작 시 컨슈머 그룹 내 동일한 컨슈머임에도 불구하고 새로운 컨슈머로 인식하여 새로운 엔티티 ID 부여
  - 그 결과, 컨슈머 그룹의 리밸런싱 발생
  - 대용량 메시지를 처리하는 컨슈머 그룹인 경우, 리밸런싱 동작으로 인해 원래 상태를 복구하는 데 상당한 시간 소요 발생 가능
  - 이러한 불필요한 리밸런싱을 방지하기 위해 카프카 2.3 버전부터 '스태틱 멤버십 (static membership)' 개념 도입

> 스태틱 멤버십이란 

- 컨슈머 그룹 내에서 컨슈머가 재시작 등으로 컨슈머 그룹에서 나갔다가 재합류하더라도 리밸런싱이 일어나지 않게 함 
  - \* 컨슈머마다 인식 가능한 ID를 적용하여 그룹 코디네이터가 기존 구성원임을 인식할 수 있도록 함
  - \* 스태틱 멤버십 기능이 적용된 컨슈머인 경우, 컨슈머 그룹에서 빠지는 시점에 그룹 코디네이터에게 알리지 않으므로 불필요한 리밸런싱 방지 가능

> 스태틱 멤버십이 적용된 경우, 총 2번의 불필요 리밸런싱 방지 가능

1. 스태틱 멤버십이 적용된 컨슈머인 경우, 컨슈머 그룹에서 빠지는 시점에 그룹 코디네이터에게 알리지 않으므로 한 번의 불필요 리밸런싱 방지 
2. 이후 해당 컨슈머가 재합류할 때, 그룹 코디네이터가 컨슈머의 ID 확인을 통해 기존 구성원임을 확인하기 때문에 불필요 리밸런싱 방지

> 스태틱 멤버십 옵션 설정 방법

- \* 아파치 카프카 버전 2.3 이상 필수
- group.instance.id 설정 (기본값 : null)
  - 컨슈머 인스턴스별 고유값 입력 필요 (그룹 코디네이터에서 식별 가능해야 하기 때문)
- session.timeout.ms 를 기본값보다 크게 설정
  - 컨슈머 재시작 후 session.timeout.ms 에 지정된 시간 동안 그룹 코디네이터가 하트비트를 받지 못하는 경우, 강제 리밸런싱 발생
  - 위 상황이 발생하는 경우, 스태틱 멤버십 목적 위배
  - \* 따라서, 컨슈머 재시작 시간이 약 2분 정도 소요될 경우, session.timeout.ms 값은 2분보다 큰 값으로 설정 필요


> 일반 컨슈머 그룹의 리밸런싱 동작 과정 

1. 컨슈머 그룹 상세보기

![캡처](https://postfiles.pstatic.net/MjAyMjEwMjBfMjIw/MDAxNjY2Mjc3MjgyOTQw.bNhJhL34qxnna4gibhZVk9ZVm-THu71zF0keLvej0a4g.YteE_ZeVJG1awSddcSG-ukZhsvFb_CNxDZUsKoHGTdkg.JPEG.wnsghi1/IMG_1337.jpg?type=w773)

- 컨슈머 그룹명 : peter-consumer01
- 파티션 0 : peter-kafka03 (172.31.8.78)
- 파티션 1 : peter-kafka02 (172.31.11.46)
- 파티션 2 : peter-kafka01 (172.31.5.59)

2. 일반 컨슈머 그룹의 리밸런싱 전 동작

![캡처](https://postfiles.pstatic.net/MjAyMjEwMjBfMTcg/MDAxNjY2Mjc3MjgyNDQ5.z8RHMQcNZdUTWxAwVUt7u5adSZ6090udRUE6iohrLmwg.GRJoscGhQFOpc_nNSS15WHBI7sI5nq_7U4Fpgsz2c5cg.JPEG.wnsghi1/IMG_1338.jpg?type=w773)

3. 컨슈머 그룹 상세보기 

![캡처](https://postfiles.pstatic.net/MjAyMjEwMjBfMTEz/MDAxNjY2Mjc3MjgyMzMy.3i7BMsmYOY6GHa1NH9c0wIY0UFvdue-YXjRi-IpNBqcg.RkcSFuNpMd2lP3LmHynp3AJ40CyJvCUg_8VHqu5AZugg.JPEG.wnsghi1/IMG_1339.jpg?type=w773)

- 'peter-kafka01' 컨슈머 프로세스 강제 종료
- 그룹 코디네이터가 'peter-consumer01' 그룹에서 peter-kafka01' 의 컨슈머가 이탈 인지
- 컨슈머 그룹 리밸런싱 (첫번째)

4. 일반 컨슈머 그룹의 리밸런싱 동작

![캡처](https://postfiles.pstatic.net/MjAyMjEwMjBfMTM3/MDAxNjY2Mjc3MjgxODcz.AlufL2iabTySNU2pORWB9W7mStqJrAqIgxW6vf3iSaMg.1QeX8HZat7WR9gO0hjlRXzuvyllt5vcJWrtF0ZOvB-Yg.JPEG.wnsghi1/IMG_1340.jpg?type=w773)

- 파티션 수보다 컨슈머 수가 작기 때문에, 'peter-kafka03' 에서 실행 중인 컨슈머가 2개의 파티션 담당
- 'peter-kafka02' 컨슈머의 경우, 파티션 1을 담당하고 있었지만, 리밸런싱 동작으로 인하여 파티션 2를 담당하도록 변경
- 컨슈머의 리밸런싱은 그룹 내 전체 컨슈머를 대상으로 동작 
- 컨슈머 재합류 시 리밸런싱 재발생 (두번째)

> 스태틱 멤버십이 적용된 컨슈머 그룹의 리밸런싱 동작 과정

1. 컨슈머 그룹 상세보기

![캡처](https://postfiles.pstatic.net/MjAyMjEwMjFfMTA2/MDAxNjY2Mjc4MzkyMjIw.pWzSFuTxEYxcwyCIslnanKOLq_31Av3yT3usMNkVZwQg.6J70WVML9NxEJkFuoQLxfHMHe1jm4GYir78tUh12Rcgg.JPEG.wnsghi1/IMG_1342.jpg?type=w773)

- 컨슈머 그룹명 : peter-consumer02
- 파티션 0 : peter-kafka02 (172.31.11.46)
- 파티션 1 : peter-kafka01 (172.31.5.59)
- 파티션 2 : peter-kafka03 (172.31.8.78)

2. 스태틱 멤버십이 적용된 컨슈머 그룹의 리밸런싱 전 동작

![캡처](https://postfiles.pstatic.net/MjAyMjEwMjBfMTcg/MDAxNjY2Mjc3MjgyNDQ5.z8RHMQcNZdUTWxAwVUt7u5adSZ6090udRUE6iohrLmwg.GRJoscGhQFOpc_nNSS15WHBI7sI5nq_7U4Fpgsz2c5cg.JPEG.wnsghi1/IMG_1338.jpg?type=w773)

3. 컨슈머 그룹 상세보기

![캡처](https://postfiles.pstatic.net/MjAyMjEwMjFfMTA2/MDAxNjY2Mjc4MzkyMjIw.pWzSFuTxEYxcwyCIslnanKOLq_31Av3yT3usMNkVZwQg.6J70WVML9NxEJkFuoQLxfHMHe1jm4GYir78tUh12Rcgg.JPEG.wnsghi1/IMG_1342.jpg?type=w773)

- 'peter-kafka01' 컨슈머 프로세스 강제 종료 후 재확인
- **\* 컨슈머 1대가 강제 종료됐음에도 불구하고 변경 내용 없음 (리밸런싱 미발생)**
- **\* 'session.timeout.ms' 설정값인 30초 이후 리밸런싱 발생** 

4. 스태틱 멤버십이 적용된 컨슈머 그룹의 리밸런싱 동작

![캡처](https://postfiles.pstatic.net/MjAyMjEwMjFfMTQ1/MDAxNjY2Mjc4MzkyMzkw.RQGxDWyzGqJ-GQ5IAR0eKYMElWxhJbOEO0TbdrNk_qsg.mr7G3cxvMqSpL1PNPOASSXzXbY8y9hIuClLyhD0bTHEg.JPEG.wnsghi1/IMG_1343.jpg?type=w773)

- 스태틱 멤버십을 적용하는 경우, 'session.timeout.ms' 설정값을 넘어가지 않는다면 리밸런싱 미발생
  - 해당 컨슈머의 재실행 시간을 고려한 설정 필요
- 카프카 2.3 버전 이상 사용 시 스태틱 멤버십 적용 권장
