# Chapter 3. ë„íë¨¼íŠ¸ ìƒì„±, ê°±ì‹ , ì‚­ì œ

| docker ë¡œ mongo ìž¬ì„¤ì¹˜

````shell
$ cd ~
$ docker pull mongo
$ mkdir mongodb

# ëª½ê³ DB ì»¨í…Œì´ë„ˆì˜ ë³¼ë¥¨ì„ ë¡œì»¬ ë””ë ‰í„°ë¦¬ì™€ ë§ˆìš´íŠ¸ì‹œí‚¤ì§€ ì•Šìœ¼ë©´ ì»¨í…Œì´ë„ˆë¥¼ ì‚­ì œí•  ë•Œ
# ì»¨í…Œì´ë„ˆì— ì €ìž¥ë˜ì–´ìžˆëŠ” ë°ì´í„°ë„ ì‚­ì œë˜ê¸° ë•Œë¬¸ì— ë³µêµ¬í•  ìˆ˜ ì—†ë‹¤.
# ëª½ê³ DBì˜ ê¸°ë³¸ ë°ì´í„° ë””ë ‰í„°ë¦¬ëŠ” /data/db
# -v ~/mongodb:data/dbì„ ì‚¬ìš©í•´ ë¡œì»¬ì˜ ~/mongodb ë””ë ‰í„°ë¦¬ì™€ ë§ˆìš´íŠ¸ì‹œí‚´
$ docker run --name mongodb -v ~/mongodb:/data/db -d -p 27017:27017 mongo
ab32e314d71559a912b796b0cb7b8c88ee8655da307ef3121204fee4c97820a4

$ docker ps
CONTAINER ID   IMAGE          COMMAND                  CREATED         STATUS         PORTS                               NAMES
ab32e314d715   mongo          "docker-entrypoint.sâ€¦"   3 seconds ago   Up 2 seconds   0.0.0.0:27017->27017/tcp            mongodb

$ docker exec -it mongodb bash
root@ab32e314d715:/# mongod --version
db version v6.0.2
Build Info: {
    "version": "6.0.2",
    "gitVersion": "94fb7dfc8b974f1f5343e7ea394d0d9deedba50e",
    "openSSLVersion": "OpenSSL 1.1.1f  31 Mar 2020",
    "modules": [],
    "allocator": "tcmalloc",
    "environment": {
        "distmod": "ubuntu2004",
        "distarch": "aarch64",
        "target_arch": "aarch64"
    }
}

root@ab32e314d715:/# mongosh
Current Mongosh Log ID:	635beb2154ccc42b82b1a853
Connecting to:		mongodb://127.0.0.1:27017/?directConnection=true&serverSelectionTimeoutMS=2000&appName=mongosh+1.6.0
Using MongoDB:		6.0.2
Using Mongosh:		1.6.0

For mongosh info see: https://docs.mongodb.com/mongodb-shell/

To help improve our products, anonymous usage data is collected and sent to MongoDB periodically (https://www.mongodb.com/legal/privacy-policy).
You can opt-out by running the disableTelemetry() command.

------
   The server generated these startup warnings when booting
   2022-10-28T14:45:15.812+00:00: Access control is not enabled for the database. Read and write access to data and configuration is unrestricted
   2022-10-28T14:45:15.812+00:00: vm.max_map_count is too low
------

------
   Enable MongoDB's free cloud-based monitoring service, which will then receive and display
   metrics about your deployment (disk utilization, CPU, operation statistics, etc).

   The monitoring data will be available on a MongoDB website with a unique URL accessible to you
   and anyone you share the URL with. MongoDB may use this information to make product
   improvements and to suggest MongoDB products and deployment options to you.

   To enable free monitoring, run the following command: db.enableFreeMonitoring()
   To permanently disable this reminder, run the following command: db.disableFreeMonitoring()
------

test>
````

## 1. ë„íë¨¼íŠ¸ ì‚½ìž… 

- ì‚½ìž… : ëª½ê³ DBì— ë°ì´í„°ë¥¼ ì¶”ê°€í•˜ëŠ” ê¸°ë³¸ ë°©ë²•
- `insertOne` ë©”ì„œë“œ : ë„íë¨¼íŠ¸ë¥¼ ì‚½ìž…
````shell
test> db.movies.insertOne({"title" : "Stand by Me"})
{
  acknowledged: true,
  insertedId: ObjectId("635beca8ecaec72e722b80e7")
}

test> db.movies.findOne()
{ _id: ObjectId("635beca8ecaec72e722b80e7"), title: 'Stand by Me' }
````

### 1-1. insertMany

- `insertMany` : ì—¬ëŸ¬ ë„íë¨¼íŠ¸ë¥¼ ì»¬ë ‰ì…˜ì— ì‚½ìž…. ë„íë¨¼íŠ¸ ë°°ì—´ì„ ë°ì´í„°ë² ì´ìŠ¤ì— ì „ë‹¬í•œë‹¤.
  - ë„íë¨¼íŠ¸ë¥¼ ëŒ€ëŸ‰ ì‚½ìž…í•˜ë¯€ë¡œ í›¨ì”¬ ë” íš¨ìœ¨ì ì´ë‹¤.
````shell
test> db.movies.drop()
true

test> db.movies.insertMany([{"title" : "Ghostbusters"},
...                         {"title" : "E.T."},
...                         {"title" : "Blade Runner"}]);
{
  acknowledged: true,
  insertedIds: {
    '0': ObjectId("635beeffecaec72e722b80e8"),
    '1': ObjectId("635beeffecaec72e722b80e9"),
    '2': ObjectId("635beeffecaec72e722b80ea")
  }
}

test> db.movies.find()
[
  { _id: ObjectId("635beeffecaec72e722b80e8"), title: 'Ghostbusters' },
  { _id: ObjectId("635beeffecaec72e722b80e9"), title: 'E.T.' },
  { _id: ObjectId("635beeffecaec72e722b80ea"), title: 'Blade Runner' }
]
````

- `insertMany` ëŠ” ì—¬ëŸ¬ ë„íë¨¼íŠ¸ë¥¼ ë‹¨ì¼ ì»¬ë ‰ì…˜ì— ì‚½ìž…í•  ë•Œ ìœ ìš©í•˜ë‹¤.
- í•œ ë²ˆì— ì¼ê´„ ì‚½ìž…í•  ìˆ˜ ìžˆëŠ” ë°ì´í„°ì˜ í¬ê¸°ì—ëŠ” ì œí•œì´ ìžˆë‹¤.
  - `48MB` ë³´ë‹¤ í° ë©”ì‹œì§€ë¥¼ í—ˆìš©í•˜ì§€ ì•ŠìŒ
    - ì‚½ìž…ëœ ë°ì´í„°ë¥¼ 48MB í¬ê¸°ì˜ ì¼ê´„ ì‚½ìž… ì—¬ëŸ¬ ê°œë¡œ ë¶„í• í•œë‹¤.

- ë°°ì—´ ì¤‘ê°„ì— ìžˆëŠ” ë„íë¨¼íŠ¸ì—ì„œ íŠ¹ì • ìœ í˜•ì˜ ì˜¤ë¥˜ê°€ ë°œìƒí•˜ëŠ” ê²½ìš°, ì •ë ¬ ì—°ì‚°ì„ ì„ íƒí–ˆëŠ”ì§€ í˜¹ì€ ë¹„ì •ë ¬ ì—°ì‚°ì„ ì„ íƒí–ˆëŠ”ì§€ì— ë”°ë¼ ë°œìƒí•˜ëŠ” ìƒí™©ì´ ë‹¬ë¼ì§„ë‹¤.
  - ì˜µì…˜ ë„íë¨¼íŠ¸ì— `ordered` í‚¤ì— `true` ë¥¼ ì§€ì • (default)
    - ë„íë¨¼íŠ¸ê°€ ì œê³µëœ ìˆœì„œëŒ€ë¡œ ì‚½ìž…ë¨ 
    - ì‚½ìž… ì˜¤ë¥˜ë¥¼ ìƒì„±í•˜ë©´, ë°°ì—´ì—ì„œ í•´ë‹¹ ì§€ì ì„ ë²—ì–´ë‚œ ë„íë¨¼íŠ¸ëŠ” ì‚½ìž…ë˜ì§€ ì•ŠëŠ”ë‹¤.
        ````shell
        # "_id"ê°€ ë™ì¼í•œ ë„íë¨¼íŠ¸ë¥¼ ë‘ ê°œ ì´ìƒ ì‚½ìž…í•  ìˆ˜ ì—†ìœ¼ë¯€ë¡œ ì„¸ ë²ˆì§¸ ë„íë¨¼íŠ¸ê°€ ì˜¤ë¥˜ë¥¼ ë°œìƒì‹œí‚¨ë‹¤.
        test> db.movies.insertMany([
        ... {"_id" : 0, "title" : "Top Gun"},
        ... {"_id" : 1, "title" : "Back to the Future"},
        ... {"_id" : 1, "title" : "Gremlins"},
        ... {"_id" : 2, "title" : "Aliens"}])
        Uncaught:
        MongoBulkWriteError: E11000 duplicate key error collection: test.movies index: _id_ dup key: { _id: 1 }
        Result: BulkWriteResult {
          result: {
            ok: 1,
            writeErrors: [
              WriteError {
                err: {
                  index: 2,
                  code: 11000,
                  errmsg: 'E11000 duplicate key error collection: test.movies index: _id_ dup key: { _id: 1 }',
                  errInfo: undefined,
                  op: { _id: 1, title: 'Gremlins' }
                }
              }
            ],
            writeConcernErrors: [],
            insertedIds: [
              { index: 0, _id: 0 },
              { index: 1, _id: 1 },
              { index: 2, _id: 1 },
              { index: 3, _id: 2 }
            ],
            nInserted: 2,
            nUpserted: 0,
            nMatched: 0,
            nModified: 0,
            nRemoved: 0,
            upserted: []
          }
        }
        ````
    - ì˜µì…˜ ë„íë¨¼íŠ¸ì— `ordered` í‚¤ì— `false`ë¥¼ ì§€ì •
      - ëª½ê³ DBê°€ ì„±ëŠ¥ì„ ê°œì„ í•˜ë ¤ê³  ì‚½ìž…ì„ ìž¬ë°°ì—´í•  ìˆ˜ ìžˆë‹¤. 
      - ì¼ë¶€ ì‚½ìž…ì´ ì˜¤ë¥˜ë¥¼ ë°œìƒì‹œí‚¤ëŠ”ì§€ ì—¬ë¶€ì— ê´€ê³„ì—†ì´ ëª¨ë“  ë„íë¨¼íŠ¸ ì‚½ìž…ì„ ì‹œë„í•œë‹¤.
        ````shell
        # ì„¸ ë²ˆì§¸ ë„íë¨¼íŠ¸ë§Œ ì¤‘ë³µëœ "_id" ì˜¤ë¥˜ ë•Œë¬¸ì— ì‚½ìž…ì— ì‹¤íŒ¨í–ˆë‹¤.
        test> db.movies.insertMany([
        ... {"_id" : 3, "title" : "Sixteen Candles"},
        ... {"_id" : 4, "title" : "The Terminator"},
        ... {"_id" : 4, "title" : "The Princess Bride"},
        ... {"_id" : 5, "title" : "Scarface"}],
        ... {"ordered" : false})
        Uncaught:
        MongoBulkWriteError: E11000 duplicate key error collection: test.movies index: _id_ dup key: { _id: 4 }
        Result: BulkWriteResult {
          result: {
            ok: 1,
            writeErrors: [
              WriteError {
                err: {
                  index: 2,
                  code: 11000,
                  errmsg: 'E11000 duplicate key error collection: test.movies index: _id_ dup key: { _id: 4 }',
                  errInfo: undefined,
                  op: { _id: 4, title: 'The Princess Bride' }
                }
              }
            ],
            writeConcernErrors: [],
            insertedIds: [
              { index: 0, _id: 3 },
              { index: 1, _id: 4 },
              { index: 2, _id: 4 },
              { index: 3, _id: 5 }
            ],
            nInserted: 3,
            nUpserted: 0,
            nMatched: 0,
            nModified: 0,
            nRemoved: 0,
            upserted: []
          }
        }
        ````

### 1-2. ì‚½ìž… ìœ íš¨ì„± ê²€ì‚¬

- ëª½ê³ DBëŠ” ì‚½ìž…ëœ ë°ì´í„°ì— ìµœì†Œí•œì˜ ê²€ì‚¬ë¥¼ ìˆ˜í–‰í•œë‹¤.
  - `_id` í•„ë“œê°€ ì¡´ìž¬í•˜ì§€ ì•Šìœ¼ë©´ ìƒˆë¡œ ì¶”ê°€
  - ëª¨ë“  ë„íë¨¼íŠ¸ëŠ” `16MB`ë³´ë‹¤ ìž‘ì•„ì•¼ í•˜ë¯€ë¡œ í¬ê¸°ë¥¼ ê²€ì‚¬
    - doc ë¼ëŠ” ë„íë¨¼íŠ¸ì˜ Binary JSON(BSON) í¬ê¸°(ë°”ì´íŠ¸ ë‹¨ìœ„)ë¥¼ ë³´ë ¤ë©´ `bsonsize(doc)` ë¥¼ ì‹¤í–‰í•œë‹¤.
    ````shell
    test> doc = { subject: "MongoDB", name: "The definitive guide of MongoDB 3e" }
    { subject: 'MongoDB', name: 'The definitive guide of MongoDB 3e' }
    
    test> bsonsize(doc)
    71
    ````
    
### 1-3. ì‚½ìž…

- ë„íë¨¼íŠ¸ë¥¼ ëª½ê³ DBì— ì‚½ìž…
  - ëª½ê³ DB 3.0 ì´ì „ ë²„ì „: insert
  - ëª½ê³ DB 3.0 ~ : insertOne, insertManyë¿ ì•„ë‹ˆë¼ ë‹¤ë¥¸ ì—¬ëŸ¬ ë°©ë²•

## 2. ë„íë¨¼íŠ¸ ì‚­ì œ

- `deleteOne` : í•„í„°ì™€ ì¼ì¹˜í•˜ëŠ” ì²« ë²ˆì§¸ ë„íë¨¼íŠ¸ë¥¼ ì‚­ì œí•œë‹¤.
````shell
test> db.movies.find()
[
  { _id: ObjectId("635beeffecaec72e722b80e8"), title: 'Ghostbusters' },
  { _id: ObjectId("635beeffecaec72e722b80e9"), title: 'E.T.' },
  { _id: ObjectId("635beeffecaec72e722b80ea"), title: 'Blade Runner' },
  { _id: 0, title: 'Top Gun' },
  { _id: 1, title: 'Back to the Future' },
  { _id: 3, title: 'Sixteen Candles' },
  { _id: 4, title: 'The Terminator' },
  { _id: 5, title: 'Scarface' }
]

test> db.movies.deleteOne({"_id" : 4})
{ acknowledged: true, deletedCount: 1 }

test> db.movies.find()
[
  { _id: ObjectId("635beeffecaec72e722b80e8"), title: 'Ghostbusters' },
  { _id: ObjectId("635beeffecaec72e722b80e9"), title: 'E.T.' },
  { _id: ObjectId("635beeffecaec72e722b80ea"), title: 'Blade Runner' },
  { _id: 0, title: 'Top Gun' },
  { _id: 1, title: 'Back to the Future' },
  { _id: 3, title: 'Sixteen Candles' },
  { _id: 5, title: 'Scarface' }
]
````

`deleteMany` : í•„í„°ì™€ ì¼ì¹˜í•˜ëŠ” ëª¨ë“  ë„íë¨¼íŠ¸ë¥¼ ì‚­ì œ
````shell
test> db.movies.drop()
true

test> db.movies.insertMany([
... {"_id" : 0, "title" : "Top Gun", "year" : 1986},
... {"_id" : 1, "title" : "Back to the Future", "year" : 1985},
... {"_id" : 3, "title" : "Sixteen Candles", "year" : 1984},
... {"_id" : 4, "title" : "The Terminator", "year" : 1984},
... {"_id" : 5, "title" : "Scarface", "year" : 1983}])
{
  acknowledged: true,
  insertedIds: { '0': 0, '1': 1, '2': 3, '3': 4, '4': 5 }
}

test> db.movies.deleteMany({"year" : 1984})
{ acknowledged: true, deletedCount: 2 }

test> db.movies.find()
[
  { _id: 0, title: 'Top Gun', year: 1986 },
  { _id: 1, title: 'Back to the Future', year: 1985 },
  { _id: 5, title: 'Scarface', year: 1983 }
]

test> db.movies.deleteMany({})
{ acknowledged: true, deletedCount: 3 }
````

- ë„íë¨¼íŠ¸ë¥¼ ì‚­ì œ
  - ëª½ê³ DB 3.0 ì´ì „ ë²„ì „ : remove
  - ëª½ê³ DB 3.0 ~ : deleteOneê³¼ deleteMany ë“± ì—¬ëŸ¬ ë©”ì„œë“œ

### 2-1. drop

- `drop` : ì „ì²´ ì»¬ë ‰ì…˜ì„ ì‚­ì œ. ê·¸ë¦¬ê³  ë¹ˆ ì»¬ë ‰ì…˜ì— ì¸ë±ìŠ¤ë¥¼ ìž¬ìƒì„±í•œë‹¤.
  - ðŸ’¡ ì´ì „ì— ë°±ì—…ëœ ë°ì´í„°ë¥¼ ë³µì›í•˜ëŠ” ë°©ë²• ì™¸ì— `delete` ë˜ëŠ” `drop` ìž‘ì—…ì„ ì·¨ì†Œí•˜ê±°ë‚˜ ì‚­ì œëœ ë„íë¨¼íŠ¸ë¥¼ ë³µêµ¬í•˜ëŠ” ë°©ë²•ì€ ì—†ë‹¤.
````shell
test> db.movies.drop()
true
````
  