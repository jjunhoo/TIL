# Chapter 2. 몽고DB 기본

- 몽고DB의 기본 개념
  - `도큐먼트` : 몽고DB 데이터의 기본 단위. 관계형 데이터베이스의 행과 유사하다
  - `컬렉션` : 동적 스키마가 있는 테이블과 같다.
  - 몽고DB의 단일 인스턴스는 자체적인 컬렉션을 갖는 여러 개의 독립적인 데이터베이스를 호스팅한다.
    - MongoDB 하나의 서버(인스턴스) 안에는 여러 개의 데이터베이스를 만들 수 있고, 각 데이터베이스는 자기만의 컬렉션(테이블 같은 것)을 가질 수 있다
  - 모든 도큐먼트는 컬렉션 내에서 고유한 특수키인 `_id`를 가진다.
  - 몽고DB는 몽고 셸 이라는 간단하지만 강력한 도구와 함께 배포된다.
    - 몽고 셸은 몽고DB 인스턴스를 관리하고 몽고DB 쿼리 언어로 데이터를 조작하기 위한 내장 지원을 제공한다.
    - 또한 사용자가 다양한 목적으로 자신의 스크립트를 만들고 로드할 수 있는 완전한 기능의 자바스크립트 해석기다.

## 1. 도큐먼트

- 몽고DB의 핵심
  - 정렬된 키와 연결된 값의 집합으로 이뤄진 도큐먼트
- 대부분의 언어는 맵, 해시, 딕셔너리와 같이 도큐먼트를 자연스럽게 표현하는 자료구조를 가진다.
- 도큐먼트의 키는 문자열이다. 다음 예외 몇 가지를 제외하면 어떤 UTF-8 문자든 쓸 수 있다.
  - 키는 `\0`(null 문자)를 포함하지 않는다. `\0`은 키의 끝을 나타내는 데 사용된다.
  - `.` 과 `$` 문자는 몇 가지 특별한 속성을 가지며 이후 장에서 설명할 특정 상황에만 사용해야 한다
    - 이 문자들은 보통 예약어로 취급해야 하며 부적절하게 사용하면 드라이버에서 경고를 발생한다.

- 몽고DB는 데이터형과 대소문자를 구별한다.
  - 다음 두 도큐먼트는 서로 다르다.
    ````json
    {"count": 5}
    {"count": "5"}

    {"count": 5}
    {"Count": 5}
    ````

- 몽고DB에서는 키가 중복될 수 없음
  - 다음 도큐먼트는 올바른 도큐먼트가 아니다.
    ````json
    {"greeting" : "Hello, world!", "greeting" : "Hello, MongoDB!"}
    ````

## 2. 컬렉션

- 컬렉션: 도큐먼트의 모음이다.
    - 관계형 데이터베이스의 테이블에 대응된다.

### 2-1. 동적 스키마

- 컬렉션은 동적 스키마를 갖는다.
  - 하나의 컬렉션 내 도큐먼트들이 모두 다른 구조를 가질 수 있다는 의미
    ````json
    // 다음 도큐먼트들을 하나의 컬렉션에 저장할 수 있다.
    {"greeting" : "Hello, world!", "vies" : 3}
    {"signoff" : "Good night, and good luck"}
    ````
  - 도큐먼트들의 키, 키의 개수, 데이터형의 값은 모두 다르다.

### 2-2. 네이밍 

- 컬렉션은 이름으로 식별된다. 컬렉션명은 어떤 UTF-8 문자열이든 쓸 수 있지만 몇 가지 제약 조건이 있다.
  - 빈 문자열(" ")은 유효한 컬렉션명이 아니다.
  - `\0` (null 문자)은 컬렉션명의 끝을 나타내는 문자이므로 컬렉션명에 사용할 수 없다.
  - `system.`으로 시작하는 컬렉션명은 시스템 컬렉션에서 사용하는 예약어이므로 사용할 수 없다.
    - `system.users` 컬렉션에는 데이터베이스 사용자 정보가, `system.namespaces` 컬렉션에는 데이터베이스 내 모든 컬렉션의 정보가 들어 잇다.
  - 사용자가 만든 컬렉션은 이름에 예약어인 `$`를 포함할 수 없다.
    - 시스템에서 생성한 몇몇 컬렉션에서 `$` 문자를 사용하므로 데이터베이스에서 사용하는 다양한 드라이버가 $ 문자를 포함하는 컬렉션명을 지원하기는 한다 → 이런 컬렉션에 접근할 때가 아니라면 `$`를 컬렉션명에 사용해서는 안 된다

- 서브컬렉션
  - 서브컬렉션의 네임스페이스에 `.` 문자를 사용해 컬렉션을 체계화한다.
    - 블로그 기능이 있는 애플리케이션은 blog.posts 와 blog.authors 라는 컬렉션을 가질 수 있다.
    - 큰 파일을 저장하는 프로토콜인 GridFS는 콘텐츠 데이터와 별도로 메타데이터를 저장하는 데 서브컬렉션을 사용한다.
    - 대부분의 드라이버는 특정 컬렉션의 서브컬렉션에 접근하는 몇 가지 편리한 문법을 제공한다.
      - 데이터베이스 셸에서 db.blog는 blog 컬렉션을, db.blog.posts는 blog.posts 컬렉션을 보여준다.

## 3. 데이터베이스

- 몽고DB는 컬렉션에 도큐먼트를 그룹화할 뿐 아니라 데이터베이스에 컬렉션을 그룹지어 놓는다.
- 데이터베이스는 컬렉션과 마찬가지로 이름으로 식별된다. 데이터베이스 이름에는 어떤 UTF-8 문자열이든 쓸 수 있지만 몇 가지 제약 조건이 있다.
  - 빈 문자열(" ")은 유효한 데이터베이스 이름이 아니다.
  - 데이터베이스 이름은 다음 문자를 포함할 수 없다. /, \, ., ' ', *, <, >, :, |, ?, $, (단일 공간), \0(null 문자)
  - 데이터베이스 이름은 대소문자를 구별한다.
  - 데이터베이스 이름은 최대 64바이트다.

- 직접 접근할 수는 있지만 특별한 의미론(semantics)을 갖는 예약된 데이터베이스 이름도 있다.
  - admin
    - 인증(authentication)과 권한 부여(authorization) 역할을 한다.
    - 일부 관리 작업을 하려면 이 데이터베이스에 대한 접근이 필요하다.
  - local
    - 단일 서버에 대한 데이터를 저장한다.
    - 복제 셋(replica set)에서 local은 복제(replication) 프로세스에 사용된 데이터를 저장한다.
      - local 데이터베이스 자체는 복제되지 않는다.
  - config
    - 샤딩된 몽고DB 클러스터는 config 데이터베이스를 사용해 각 샤드의 정보를 저장한다.
- 컬렉션을 저장하는 데이터베이스의 이름을 컬렉션명 앞에 붙이면 올바른 컬렉션명인 네임스페이스를 얻는다.
  - cms 데이터베이스의 blog.posts 컬렉션을 사용 → 컬렉션의 네임스페이스는 cms.blog.posts

## 4. 몽고DB 시작

- 서버를 시작하려면 원하는 유닉스 명령행 환경에서 mongod 실행 파일을 실행한다.
    ````shell
    # 몽고DB 설치
    $ brew tap mongodb/brew
    ..
    
    $ brew install mongodb-community
    ..
    
    $ brew services start mongodb/brew/mongodb-community
    ..
    ==> Successfully started `mongodb-community` (label: homebrew.mxcl.mongodb-community)
    
    $ mongod --version
    db version v6.0.1
    Build Info: {
        "version": "6.0.1",
        "gitVersion": "32f0f9c88dc44a2c8073a5bd47cf779d4bfdee6b",
        "modules": [],
        "allocator": "system",
        "environment": {
            "distarch": "aarch64",
            "target_arch": "aarch64"
        }
    }
    ````
- mongod는 인수(argument) 없이 실행하면 기본 데이터 디렉토리로 /data/db(윈도우에서는 \data\db\)를 사용한다.
  - 데이터 디렉터리가 존재하지 않거나 쓰기 권한이 없을 때는 서버가 실행되지 않는다.
- 시작할 때 서버는 버전과 시스템 정보를 출력한 후 클라이언트의 연결을 기다린다. 몽고DB는 기본적으로 27017번 포트에서 소켓 연결을 기다린다.