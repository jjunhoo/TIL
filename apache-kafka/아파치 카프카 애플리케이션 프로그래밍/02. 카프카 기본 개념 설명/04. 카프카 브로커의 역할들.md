## 카프카 브로커의 역할들

> 브로커의 역할 : 컨트롤러, 데이터 삭제, 컨슈머 오프셋 저장, 그룹 코디네이터

> 컨트롤러
  - 클러스터의 다수 브로커 중 1대가 컨트롤러 역할을 수행
  - 컨트롤러는 다른 브로커들의 상태를 체크하고, 특정 브로커가 클러스터에서 빠지는 경우, 해당 브로커에 존재하는 '리더 파티션' 을 재분배
    - 카프카는 지속적으로 데이터를 처리하는 것이 중요하므로 브로커의 상태가 비정상이라면, 빠르게 클러스터에서 제거하는 것이 중요
  - 만약, 컨트롤러 역할을 수행하는 브로커에 장애 발생 시 다른 브로커가 컨트롤러 역할 수행

> 데이터 삭제
  - 카프카는 다른 메시징 플랫폼과는 다르게, 컨슈머가 데이터를 가져가더라도 토픽의 데이터는 삭제되지 않음
    - 컨슈머나 프로듀서가 데이터 삭제를 요청하는 것도 불가능
    - 오직, 브로커만이 데이터 삭제 가능
  - 데이터 삭제는 브로커에서 파일 단위로 이루어지는데, 이 단위를 '로그 세그먼트 (Log Segment)' 라고 부름
    - 로그 세그먼트에는 다수의 데이터가 들어있기 때문에 일반적인 DB처럼 특정 데이터를 선별해서 삭제 불가능
    - delete : 일정 시간, 용량에 따라 삭제 수행 가능
    - compact : key 를 기준으로 가장 최근의 메시지를 제외한 나머지 메시지 삭제 가능 

> 컨슈머 오프셋 저장
  - 컨슈머 그룹은 토픽의 특정 파티션으로부터 데이터를 가져가서 처리하고, 해당 파티션의 어느 레코드까지 가져갔는지 확인하기 위해 '오프셋'을 '커밋' 
  - 커밋한 오프셋은 '__consumer_offsets' 토픽에 저장
    - 카프카 운영 시 자동 생성 
    - 여기에 저장된 오프셋을 기준으로 컨슈머 그룹은 다음 레코드를 가져가서 처리
    - 컨슈머의 장애나 컨슈머 restart 를 통해 재기동 될 때, '__consumer_offsets' 에 저장된 컨슈머 오프셋을 기준으로 이어서 처리 가능

> 그룹 코디네이터
  - 코디네이터는 컨슈머 그룹의 상태를 체크하고, 파티션을 컨슈머와 매칭되도록 분배하는 역할 수행
  - 특정 컨슈머가 컨슈머 그룹에서 빠지게 되면, 매칭되지 않은 파티션을 정상 동작하는 컨슈머로 할당하여 끊임없이 데이터가 처리되도록 도와줌
    - 파티션을 컨슈머로 재할당하는 과정을 '리밸런스(rebalance)' 라고 함
